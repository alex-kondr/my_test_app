from agent import *from models.products import *def run(context, session):    session.sessionbreakers = [SessionBreak(max_requests=5000)]    session.queue(Request("https://www.pcguru.hu/tesztek"), process_revlist, dict())def process_revlist(data, context, session):    revs = data.xpath("//div[@class='listed-items news']/div/a")    for rev in revs:        name = rev.xpath("@title").string()        if not name:            name = rev.xpath("span[@class='simple-title']/text()").string()        if not name:            name = rev.xpath("img/@alt").string()        url = rev.xpath("@href").string()        if ".pdf" not in url:            session.queue(Request(url), process_review, dict(name=name, url=url))    next_url = data.xpath("//link[@rel='next']/@href").string()    if next_url:        session.queue(Request(next_url), process_revlist, dict(context))def process_review(data, context, session):    product = Product()    product.name = context["name"].split(" teszt")[0].split(" játékteszt")[0]    product.url = context["url"].split('#')[0]    product.ssid = product.url.split('/')[-1]    product.manufacturer = data.xpath("//div[@class='games-infobox']/dl[dt[text()='Fejlesztő']]/dd/a/@title").string()    platform = data.xpath("//div[@class='details-box details-platform']/text()").string().split(',')[0].split(' ')[0]    product.category = "Games|" + platform    review = Review()    review.type = "pro"    review.title = context["name"]    review.ssid = product.ssid    review.url = product.url    review.date = data.xpath("//div[@class='post-meta']/div[@class='left']/span[contains(text(), 'Dátum')]/following-sibling::text()").string()    if review.date:        review.date = "".join(review.date.split()[:-1])    grade_info = data.xpath("//script[contains(text(), 'Games.startGameCounter')]/text()").string()    if grade_info:        grade_info = grade_info.split("startGameCounter(")[-1].split(')')[0]        overall = int(grade_info.split(',')[0].strip())        if not overall == 0:            review.grades.append(Grade(type="overall", value=overall, best=100))        user_grade = int(grade_info.split(',')[-1].strip())        if not user_grade == 0:            review.grades.append(Grade(name="User Rating", value=user_grade, best=100))    grades = data.xpath("//div[contains(@class, 'vote-result-box')]/p")    for grade in grades:        name = grade.xpath("text()").string()        value = int(grade.xpath("following-sibling::div[@class='vote-result-bar'][1]/span/@style").string().split("width:")[-1].split('%')[0])        review.grades.append(Grade(name=name, value=value, best=100))    pros = data.xpath("//div[@class='opinion pro']/text()")    for pro in pros:        pro = pro.string()        pro = re_search_once(r'^ ?\+(.*)', pro) or pro        if pro:            pro = pro.strip()            review.add_property(type="pros", value=pro)    cons = data.xpath("//div[@class='opinion kontra']/text()")    for con in cons:        con = con.string()        con = re_search_once(r'^ ?-(.*)', con) or con        if con:            con = con.strip()            review.add_property(type="cons", value=con)    author = data.xpath("//div[@class='post-meta']/div[@class='left']/a").first()    if author:        name = author.xpath("text()").string()        url = author.xpath("@href").string()        review.authors.append(Person(name=name, ssid=name, profile_url=url))    summary = data.xpath("//div[@class='post-lead']/text()").string()    if summary:        review.add_property(type="summary", value=summary)    conclusion = data.xpath("//div[@class='blockcontent mb0']/p[@class='mb0']/text()").string(multiple=True)    if not conclusion:        conclusion = data.xpath("//div[@class='content-text'][h2[strong[regexp:test(text(), 'az összkép számít|VÉLEMÉNY', 'i')]]]/p//text()").string(multiple=True)    if conclusion:        review.add_property(type="conclusion", value=conclusion)    excerpt = data.xpath("//div[@class='content-text']/p//text()").string(multiple=True)    if excerpt:        if conclusion:            excerpt = excerpt.split(conclusion.strip())[0]        review.add_property(type="excerpt", value=excerpt)        product.reviews.append(review)        session.emit(product)