from agent import *from models.products import *XCAT = ['Kezdőlap', 'Szolgátatás']def run(context, session):    session.queue(Request('http://www.hardver-teszt.hu/', use='curl'), process_frontpage, {})def process_frontpage(data, context, session):    cats = data.xpath('//div[@class="cat-box-title"]//a')    for cat in cats:        name = cat.xpath('text()').string()        url = cat.xpath('@href').string()        if url and name and name not in XCAT:            session.queue(Request(url, use='curl'), process_revlist, dict(cat=name))def process_revlist(data, context, session):    revs = data.xpath('//h2[@class="post-box-title"]/a')    for rev in revs:        title = rev.xpath('text()').string()        url = rev.xpath('@href').string()        date = rev.xpath('following::p[@class="post-meta"][1]/span[@class="tie-date"]//text()').string()        if title and url:            session.queue(Request(url, use='curl'), process_review, dict(context, title=title, url=url, date=date))def process_review(data, context, session):    product = Product()    product.name = context['title']    product.url = context['url']    product.category = context['cat'] if context['cat'] != 'Scrolling Block' else 'Játék'    product.ssid = context['url'].split('/')[-2]    imgs = data.xpath('//div[@class="content"]//img[not(ancestor::div[@class="post-listing"])]/@src')    for img in imgs:        img = img.string()        product.properties.append(ProductProperty(type='image', value=dict(src=img, type='product')))    review = Review()    review.type = "pro"    review.title = context['title']    review.url = product.url    review.ssid = product.ssid    date = context.get('date')    if date:        review.date = date.strip('.').replace('.', '-')    author = data.xpath('//div[@class="block-head"]/h3[contains(., "About")]//text()').string()    if author:        author = author.split('About ')[-1]        review.authors.append(Person(name=author, ssid=author))    summary = data.xpath('//div[@class="entry"]//p[strong and position()=1]//text()').string()    if summary:        review.add_property(type='summary', value=summary.strip())    excerpt = data.xpath('//div[@class="entry"]//p[not(@class="post-meta")]//text()').string(multiple=True)    if excerpt:        if summary:            excerpt = excerpt.replace(summary, '')        review.properties.append(ReviewProperty(type="excerpt", value=excerpt))        product.reviews.append(review)        session.emit(product)