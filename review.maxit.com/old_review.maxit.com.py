from agent import *from models.products import *XCAT = ["Home", "Reviews", "Top Featured", ]def run(context, session):    session.queue(Request('http://www.maxit.my/category/reviews/'), process_category, dict())def process_category(data, context, session):    for link in data.xpath("//div[@class='td-big-grid-meta']//h3[contains(@class,'entry-title')]//a"):        url = link.xpath('@href').string()        if url:            session.queue(Request(url), process_product, dict(context, url=url))    process_sub_category(data, context, session)def process_sub_category(data, context, session):    for link in data.xpath("//div[@class='td-block-span4']//h3[contains(@class,'entry-title')]//a"):        url = link.xpath('@href').string()        if url:            session.queue(Request(url), process_product, dict(context, url=url))    next_page = data.xpath("//div[contains(@class,'page-nav')]//a[(.//i[@class='td-icon-menu-right'])]/@href").string()    if next_page:        session.queue(Request(next_page), process_sub_category, dict(context))def process_product(data, context, session):    product = Product()    product.url = context['url']    product.ssid = context['url'].split("/")[-2]    name = data.xpath("//h1[@class='entry-title']//text()").string(multiple=True)    if name:        product.name = name.split('Review –')[-1].split('Review:')[-1].split('Review :')[-1].split('SAY CHEESE –')[-1].split('– Review')[0].split('Review')[0]    category = data.xpath("//li[@class='entry-category'][1]//text()").string()    if category in XCAT:        product.category = 'Hi-Tech'    else:        product.category = category    review = Review()    review.url = product.url    review.title = data.xpath("//h1[@class='entry-title']//text()").string(multiple=True)    review.type = 'pro'    review.ssid = product.ssid    date = data.xpath("//time[contains(@class,'entry-date')]/@datetime").string()    if date:        review.date = date.split('T')[0]    author_name = data.xpath("//div[@class='td-post-author-name']//a//text()").string()    author_url = data.xpath("//div[@class='td-post-author-name']//a/@href").string()    if author_url:        ssid = author_url.split('/')[-2]        review.authors.append(Person(name=author_name, ssid=ssid, profile_url=author_url))    else:        review.authors.append(Person(name=author_name, ssid=author_name))    conclusion = data.xpath("//p[contains(.,'Verdict') or contains(.,'Conclusion') and (.//br) and not(contains(.,'www.'))]//text()").string(multiple=True)    if conclusion == "Verdict":        conclusion = data.xpath("//*[contains(.,'Verdict') or contains(.,'Conclusion')]/following-sibling::p[not(contains(.,'www.'))]//text()").string(multiple=True)    if not conclusion:        conclusion = data.xpath("//p[contains(.,'The verdict –')]//text()").string(multiple=True)    if not conclusion:        conclusion = data.xpath("//h2[contains(.,'Verdict') or contains(.,'Conclusion')]/following-sibling::h3[not(contains(.,'www.'))]//text()").string(multiple=True)    if not conclusion:        conclusion = data.xpath("//*[contains(.,'Verdict') or contains(.,'Conclusion')]/following-sibling::p[not(contains(.,'www.'))]//text()").string(multiple=True)    if not conclusion:        conclusion = data.xpath("//span[contains(.,'VERDICT') or contains(.,'CONCLUSION')]/following::p[not(.//br) and not(contains(.,'Contact')) and not(contains(.,'Review')) and not(contains(.,'www.'))]//text()").string(multiple=True)    if conclusion:        conclusion = conclusion.split("var td_screen_width")[0].split("Ads by Google")[0].split("©")[0].strip().replace('Verdict', '').replace('Conclusion', '')        review.add_property(type='conclusion', value=conclusion)    excerpt = data.xpath("//div[contains(@class,'td-post-content')]//p[not(contains(.,'Contact:')) and not(contains(.,'visit www.')) ]//text()").string(multiple=True)    if excerpt:        if conclusion:            excerpt = excerpt.split(conclusion.strip())[0]        excerpt = excerpt.replace('[[', '').replace(']]', '').replace('Verdict', '').replace('Conclusion', '').replace('Benchmarks & Conclusion', '').split("Specification")[0]        review.add_property(type='excerpt', value=excerpt)        product.reviews.append(review)        session.emit(product)