from agent import *from models.products import *def run(context, session):    session.queue(Request("http://www.revistait.ro/"), process_revlist, {})def process_revlist(data, context, session):    for rev in data.xpath("//div[@class='article']/article"):        name = rev.xpath("./following-sibling::h2[@class='title'][1]/a/text()").string()        url = rev.xpath("./following-sibling::h2[@class='title'][1]/a/@href").string()        cat = rev.xpath("./following-sibling::div[@class='featured-cat'][1]/text()").string()        date = rev.xpath("./following-sibling::div[@class='post-info'][1]/span[@class='thetime']/text()").string()        author = rev.xpath("./following-sibling::div[@class='post-info'][1]/span[@class='theauthor']/a/text()").string()        author_url = rev.xpath("./following-sibling::div[@class='post-info'][1]/span[@class='theauthor']/a/@href").string()        if name and url and cat and date and author and author_url:            session.queue(Request(url), process_review, dict(name=name, url=url, category=cat, date=date, author=author, author_url=author_url))    next = data.xpath("//div[@class='pagination']//a[@class='inactive'][contains(.,'Next')]/@href").string()    if next:        session.queue(Request(next), process_revlist, {})def process_review(data, context, session):    product = Product()    product.name = context['name'].split("Review: ")[-1]    product.category = context['category']    product.url = context['url']    product.ssid = context['url'].split("/")[-2]            content = data.xpath("//div[contains(@class,'post-single-content')]").first()    if content:        review = Review()        review.type = 'pro'        review.title = context['name']        review.url = context['url']        review.ssid = product.ssid        review.date = context['date']        review.authors.append(Person(name=context['author'], profile_url=context['author_url'], ssid=context['author_url'].split('/')[-2]))        summary = content.xpath("blockquote//text()").string(multiple=True)        if summary:            review.properties.append(ReviewProperty(type='summary', value=summary))        conclusion = content.xpath("p[regexp:test(normalize-space(.),'\.$')][last()]//text()").string(multiple=True)        if conclusion:            review.properties.append(ReviewProperty(type='conclusion', value=conclusion))        excerpt = content.xpath("p[regexp:test(normalize-space(.),'\.$')]//text() | ul/li//text()").string(multiple=True)        if excerpt:            if conclusion:                excerpt = excerpt.split(conclusion)[0]            if excerpt:                review.properties.append(ReviewProperty(type='excerpt', value=excerpt))        product.reviews.append(review)        session.emit(product)