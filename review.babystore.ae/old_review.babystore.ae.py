from agent import *from models.products import *XCAT = ["Feeding", "Top Brands"]def run(context, session):    session.sessionbreakers = [SessionBreak(max_requests=10000)]    session.queue(Request("https://www.babystore.ae/", use="curl"), process_frontpage, dict())def process_frontpage(data, context, session):    cats1 = data.xpath("//ul[contains(@class, 'sm_megamenu_menu')]/li")    for cat1 in cats1:        cat1_name = cat1.xpath("a//text()").string(multiple=True)        if cat1_name in XCAT:            continue        cats2 = cat1.xpath("div/div/div/div/div/div")        for cat2 in cats2:            cat2_name = cat2.xpath(".//div[@class='sm_megamenu_title']/h3//text()").string(multiple=True)            if cat2_name in XCAT:                continue            cats3 = cat2.xpath(".//div[@class='sm_megamenu_title']/a[span]")            for cat3 in cats3:                cat3_name = cat3.xpath(".//text()").string(multiple=True)                url = cat3.xpath("@href").string()                session.queue(Request(url, use="curl"), process_prodlist, dict(cat=cat1_name+'|'+cat2_name+'|'+cat3_name))def process_prodlist(data, context, session):    prods = data.xpath("//ol[contains(@class, 'product-items')]/li")    for prod in prods:        name = prod.xpath(".//a[@class='product-item-link']/@title").string()        url = prod.xpath(".//a[@class='product-item-link']/@href").string()        ssid = prod.xpath(".//div/@data-product-id").string()        session.queue(Request(url, use="curl"), process_product, dict(context, name=name, url=url, ssid=ssid))    next_url = data.xpath("//a[@title='Next']/@href").string()    if next_url:        session.queue(Request(next_url, use="curl"), process_prodlist, context)def process_product(data, context, session):    product = Product()    product.name = context["name"]    product.category = context["cat"]    product.url = context["url"]    product.ssid = context["ssid"]    product.sku = data.xpath("//div[@itemprop='sku']//text()").string()    product.manufacturer = data.xpath("//span[@class='view-brand-logo']//a/@title").string()    revs_count = data.xpath("//span[@itemprop='reviewCount']")    if revs_count:        revs_url = 'https://www.babystore.ae/review/product/listAjax/id/' + product.ssid        session.do(Request(revs_url, use="curl"), process_reviews, dict(product=product))def process_reviews(data, context, session):    product = context["product"]    revs = data.xpath("//head/following-sibling::body[1]")    for rev in revs:        review = Review()        review.type = "user"        review.url = product.url        review.title = rev.xpath(".//div[@class='review-title']//text()").string()        review.date = rev.xpath(".//time[@itemprop='datePublished']/@datetime").string()        author_name = rev.xpath(".//strong[@itemprop='author']//text()").string()        if author_name:            review.authors.append(Person(name=author_name, ssid=author_name))        grade = rev.xpath(".//span[@itemprop='ratingValue']//text()").string()        if grade:            grade = float(grade.split("%")[0]) / 20        if grade:            review.grades.append(Grade(type='overall', value=grade, best=5.0))        excerpt = rev.xpath(".//div[@itemprop='description']//text()").string(multiple=True)        if excerpt:            review.add_property(type='excerpt', value=excerpt)            review.ssid = review.digest()            product.reviews.append(review)    if product.reviews:        session.emit(product)