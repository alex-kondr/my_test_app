from agent import *from models.products import *def strip_namespace(data):    tmp = data.content_file + ".tmp"    out = file(tmp, "w")    for line in file(data.content_file):        line = line.replace('<ns0', '<')        line = line.replace('ns0:', '')        line = line.replace(' xmlns', ' abcde=')        out.write(line + "\n")    out.close()    os.rename(tmp, data.content_file)def run(context, session):    session.browser.use_new_parser = True    session.queue(Request('https://www.nextpit.it/smartphone/recensioni'), process_revlist, dict())    session.queue(Request('https://www.nextpit.it/indossabili/recensioni'), process_revlist, dict())def process_revlist(data, context, session):    strip_namespace(data)    revs = data.xpath('//article[@class="article-teaser"]')    for rev in revs:        title = rev.xpath('.//div[@class="article-teaser__link"]/a/text()').string()        url = rev.xpath('.//div[@class="article-teaser__link"]/a/@href').string()        ssid = rev.xpath('@data-id').string().split('-')[-1]        session.queue(Request(url), process_review, dict(title=title, url=url, ssid=ssid))    next_url = data.xpath('//link[@rel="next"]/@href').string()    if next_url:        session.queue(Request(next_url), process_revlist, dict())def process_review(data, context, session):    strip_namespace(data)    product = Product()    product.name = data.xpath('//div[contains(@class, "__headline")]/span/text()').string() or data.xpath('//a[contains(@class, "np-product")]/text()').string()    if not product.name:        product.name = product.name = context['title'].split(' hands-on:')[0].split(' recensione')[0].split(' la recensione')[0].split(' nel test della')[0].split('100 giorni con il ')[-1].split('giorni con ')[-1].split(' dopo un anno:')[0].split(', prima prova')[0].split('Test del ')[-1].split(', il metronomo')[0].split(' – Misura ')[0].split(' recensone')[0].split('Un anno con ')[-1].split(' test ')[0].split(' e Nokia')[0].split(' è il medio gamma')[0].split(" è l'ottimo")[0].split(' è ottimo')[0].split(' è un ')[0].split("per l'interessante ")[-1].split(' nel nostro ')[0].split(' in un primo')[0].split(' del mio ')[-1].split(' il nostro')[0].split(' - Un completo')[0].split(': il frutto')[0].split(': ')[0].split(' ci mostra')[0].split(' in azione')[0].split(' ci pensa ')[-1].rstrip('!,:').replace("'", "’").replace('l’Honor', 'Honor')    product.url = data.xpath('//li/span[contains(@class, "np-offer")]/@data-href').string() or context['url']    product.ssid = context['ssid']    cats = data.xpath('//nav[contains(@class, "breadcrumbs")]/ul/li/a[not(regexp:test(., "Home", "i"))]/text()')    category = ""    for cat in cats:        category += cat.string() + '|'    product.category = category.rstrip('|')    review = Review()    review.title = context['title'].replace("'", "’")    review.url = context['url']    review.ssid = product.ssid    review.type = 'pro'    date = data.xpath('//time[@class="articlePublishedDate"]/@datetime').string()    if date:        review.date = date.split('T')[0]    author_name = data.xpath('//span[@class="articleAuthorName"]/text()').string()    author_ssid = data.xpath('//a[@class="articleAuthorLink"]/@data-miniprofile').string()    if author_name and author_ssid:        author_ssid = author_ssid.split(': ')[-1].strip(' }')        author_url = 'https://www.nextpit.it/utente' + author_ssid        review.authors.append(Person(name=author_name, url=author_url, ssid=author_ssid))    elif author_name:        review.authors.append(Person(name=author_name, ssid=author_name))    pros = data.xpath('//ul[@class="goodList"]/li/span[contains(@class, "Content")]/text()')    for pro in pros:        pro = pro.string().replace("'", "’").strip(' ,.+-*')        if pro:            review.add_property(type="pros", value=pro)    cons = data.xpath('//ul[@class="badList"]/li/span[contains(@class, "Content")]/text()')    for con in cons:        con = con.string().replace("'", "’").strip(' ,.+-*')        if con:            review.add_property(type="cons", value=con)    grade_overall = data.xpath('//span[@class="ratingStars"]//@href').string()    if grade_overall:        grade_overall = float(grade_overall.split('stars-')[-1]) / 2        review.grades.append(Grade(type='overall', value=grade_overall, best=5.0))    summary = data.xpath('//div[@class="articlePartIntroContent"]/p//text()').string(multiple=True)    if summary:        summary = summary.replace("'", "’").replace(' . ', '. ').replace(' , ', ', ')        review.add_property(type='summary', value=summary)    conclusion = data.xpath('//div[@class="finalVerdictDesc"]/p[not(contains(., "Originariamente di "))]//text()').string(multiple=True)    if not conclusion:        conclusion = data.xpath('//div[contains(@id, "review-")]/p[.//u[regexp:test(., "In conclusione:", "i")]]/following-sibling::p//text()').string(multiple=True)    if not conclusion:        conclusion = data.xpath('//div[@class="articleContent"]//*[self::h1 or self::h2 or self::h3 or self::h4][regexp:test(., "Conclusion", "i") or regexp:test(., " verdetto", "i")]/following-sibling::p//text()').string(multiple=True)    if conclusion:        conclusion = conclusion.replace("'", "’").replace(' . ', '. ').replace(' , ', ', ').strip()        review.add_property(type='conclusion', value=conclusion)    excerpt = data.xpath('//div[@class="articleContent"]/div[contains(@id, "review") and not(contains(@id, "verdict"))]/p[not(.//u[regexp:test(., "In conclusione:", "i")])][not(regexp:test(., "Smartphone usato nel test:", "i"))][not(preceding-sibling::p[.//u[regexp:test(., "In conclusione:", "i")]])]//text()').string(multiple=True)    if not excerpt:        excerpt = data.xpath('//div[@class="articlePart articlePartContent"]/p[not(preceding-sibling::*[self::h1 or self::h2 or self::h3 or self::h4][regexp:test(., "Conclusion", "i") or regexp:test(., " verdetto", "i")])]//text()').string(multiple=True)    if excerpt:        excerpt = excerpt.replace("'", "’").replace(' . ', '. ').replace(' , ', ', ').strip()        if conclusion:            excerpt = excerpt.replace(conclusion, "")        review.add_property(type='excerpt', value=excerpt)        product.reviews.append(review)        session.emit(product)