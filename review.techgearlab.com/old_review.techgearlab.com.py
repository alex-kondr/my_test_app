from agent import *from models.products import *XCAT = ['Tools & DIY']XTITLE = ['how to', 'advice']def run(context, session):    session.sessionbreakers = [SessionBreak(max_requests=3000)]    session.queue(Request('https://www.techgearlab.com/'), process_frontpage, dict())def process_frontpage(data, context, session):    cats = data.xpath("//ul[@class='sub-menu']//li[1]")    for cat in cats:        url = cat.xpath("a/@href").string()        name = cat.xpath(".//text()").string()        if url and name and name not in XCAT:            name = name.strip('All').strip()            session.queue(Request(url), process_category, dict(cat=name))def process_category(data, context, session):    cats = data.xpath("//span[@class='h4']/following-sibling::div[@class='inline tag_list']/ul/li/a")    for cat in cats:        url = cat.xpath("@href").string()        name = cat.xpath(".//text()").string()        session.queue(Request(url), process_category, dict(context, url=url, cat=context['cat']+'|'+name))        revs = data.xpath("//div[@id='tag_tiles']/div[1]/div[@class='tag_tile_text_area']")    for rev in revs:        title = rev.xpath(".//h3/span//text()").string(multiple=True)        url =  rev.xpath("a//@href").string()        if url and title:            test_title = True            for x_title in XTITLE:                if x_title in title.lower():                    test_title = False            if test_title:                session.queue(Request(url), process_product, dict(context, url=url, title=title))    next_url = data.xpath("//link[@rel='next']/@href").string()     if next_url:        session.queue(Request(next_url), process_category, dict(context))        if not cats and not revs and not next_url:        context['title'] = context['cat']        if '|' in context['title']:            context['title'] = context['title'].split('|')[-1]                process_product(data, context, session)def process_product(data, context, session):    if 'best ' in context['title'].lower():        process_multiple_products(data, context, session)        return    print('process with process_product')        product = Product()    product.name = context['title'].split(' Review')[0].split(' review')[0]    product.ssid = context['url'].split('/')[-1].split('.html')[0]    product.category = context['cat']    product.url = context['url']    product.manufacturer = data.xpath("(//span[@class='h5-gray' and contains(.,'Manufacturer:')]/following-sibling::span[@class='h5-black'])[1]/a//text()").string()        review = Review()    review.title = context['title']    review.ssid = product.ssid    review.type = 'pro'    review.url = context['url']    date = data.xpath("((//div[@class='small'])[1]/text())[last()]").string()    if date and '⋅' in date:        review.date = date.split('⋅')[-1].strip()        authors = data.xpath("(//div[@class='small'])[1]//a")    for author in authors:        author_name = author.xpath(".//text()").string()        author_url = author.xpath("@href").string()        review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_name))    if not authors:        author_name = data.xpath("(//div[@class='small'])[1]//text()").string()        if author_name and 'By ' in author_name:            author_name = author_name.split('By ')[1].split('⋅')[0]            review.authors.append(Person(name=author_name, ssid=author_name))        grades = data.xpath("//ul[@class='rating_chart']/li")    for grade in grades:        grade_name = grade.xpath("div/span//text()").string()        grade_val = grade.xpath("div/div/@style").string()        if grade_name and grade_val:            grade_name = grade_name.split('-')[0].strip()            grade_val = grade_val.replace('width:', '').replace('%', '').replace(';', '').strip()            if grade_name != 'Overall':                review.grades.append(Grade(name=grade_name, value=float(grade_val)/10, best=10.0))        grade_overall = data.xpath("//div[@class='rating_chart_score table_score_top']//text()").string()    if grade_overall:        review.grades.append(Grade(type='overall', value=float(grade_overall), best=100.0))        pros = data.xpath("(//span[@class='h5-gray' and text()='Pros:  ']/following-sibling::span[@class='h5-black'])[1]//text()")    for pro in pros:        pro = pro.xpath(".//text()").string(multiple=True)        if pro:            review.add_property(type='pros', value=pro)        cons = data.xpath("(//span[@class='h5-gray' and text()='Cons:  ']/following-sibling::span[@class='h5-black'])[1]//text()")    for con in cons:        con = con.xpath(".//text()").string(multiple=True)        if con:            review.add_property(type='cons', value=con)        summary = data.xpath("//div[@class='subhead']//text()").string(multiple=True)    if summary:        summary = summary.strip()        review.properties.append(ReviewProperty(type='summary', value=summary))        conclusion = data.xpath("//div[@class='summary_larger']//text()").string(multiple=True)    if conclusion:        conclusion = conclusion.strip()        review.properties.append(ReviewProperty(type='conclusion', value=conclusion))        excerpt = data.xpath("//div[@class='articletext']//p//text()").string(multiple=True)    if excerpt:        excerpt = excerpt.strip()        if summary:            excerpt = excerpt.replace(summary, '')        if conclusion:            excerpt = excerpt.replace(conclusion, '')        review.properties.append(ReviewProperty(type='excerpt', value=excerpt))            product.reviews.append(review)        session.emit(product)def process_multiple_products(data, context, session):    revs = data.xpath("//div[@class='award_right_rating']")    if not revs:        process_multiple_products_2(data, context, session)        print('process with process_multiple_products')    for rev in revs:        product = Product()        product.name = rev.xpath("h3//text()").string()        product.category = context['cat']        product.url = context['url']                review = Review()        review.title = rev.xpath("h2//text()").string()        review.type = 'user'        review.url = context['url']                date = data.xpath("((//div[@class='small'])[1]/text())[last()]").string()        if date and '⋅' in date:            review.date = date.split('⋅')[-1].strip()                authors = data.xpath("(//div[@class='small'])[1]//a")        for author in authors:            author_name = author.xpath(".//text()").string()            author_url = author.xpath("@href").string()            review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_name))        if not authors:            author_name = data.xpath("(//div[@class='small'])[1]//text()").string()            if author_name and 'By ' in author_name:                author_name = author_name.split('By ')[1].split('⋅')[0]                review.authors.append(Person(name=author_name, ssid=author_name))                for index in range(1, 5):            content = rev.xpath("ancestor::div[1]/following-sibling::div[" + str(index) + "]").first()            if content:                grade_overall = content.xpath(".//ul[contains(@class,'ratingSM o')]/@class").string()                if grade_overall:                    grade_overall = grade_overall.replace('ratingSM o', '').replace('star', '')                    grade_overall = float(grade_overall)                    if grade_overall > 5:                        grade_overall /= 10                    review.grades.append(Grade(type='overall', value=grade_overall, best=5.0))                                pros = content.xpath(".//div[@class='iconProText']")                for pro in pros:                    pro = pro.xpath(".//text()").string(multiple=True)                    if pro:                        review.add_property(type='pros', value=pro)                                cons = content.xpath(".//div[@class='iconConText']")                for con in cons:                    con = con.xpath(".//text()").string(multiple=True)                    if con:                        review.add_property(type='cons', value=con)                        excerpt = rev.xpath("ancestor::div[1]/following-sibling::p[1]//text()").string(multiple=True)        if excerpt:            review.properties.append(ReviewProperty(type='excerpt', value=excerpt))                    review.ssid = review.digest()            product.ssid = review.ssid            product.reviews.append(review)                if product.reviews:            session.emit(product)def process_multiple_products_2(data, context, session):    print('process with process_multiple_products_2')    revs = data.xpath("//div[@class='articletext']/h2")    for rev in revs:        product = Product()        product.name = rev.xpath("following-sibling::h3[1]//text()").string()        product.category = context['cat']        product.url = context['url']                review = Review()        review.title = rev.xpath(".//text()").string()        review.type = 'user'        review.url = context['url']        if review.title and review.title in ["Why You Should Trust Us", "Compare Products", "Analysis and Test Results", "Conclusion"]:            break                date = data.xpath("((//div[@class='small'])[1]/text())[last()]").string()        if date and '⋅' in date:            review.date = date.split('⋅')[-1].strip()                authors = data.xpath("(//div[@class='small'])[1]//a")        for author in authors:            author_name = author.xpath(".//text()").string()            author_url = author.xpath("@href").string()            review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_name))        if not authors:            author_name = data.xpath("(//div[@class='small'])[1]//text()").string()            if author_name and 'By ' in author_name:                author_name = author_name.split('By ')[1].split('⋅')[0]                review.authors.append(Person(name=author_name, ssid=author_name))                for index in range(1, 7):            content = rev.xpath("following-sibling::div[" + str(index) + "]").first()            if content:                grade_overall = content.xpath(".//ul[contains(@class,'ratingSM o')]/@class").string()                if grade_overall:                    grade_overall = grade_overall.replace('ratingSM o', '').replace('star', '')                    grade_overall = float(grade_overall)                    if grade_overall > 5:                        grade_overall /= 10                    review.grades.append(Grade(type='overall', value=grade_overall, best=5.0))                                grades = content.xpath(".//ul[@class='rating_chart']/li")                for grade in grades:                    grade_name = grade.xpath("div/span//text()").string()                    grade_val = grade.xpath("div/div/@style").string()                    if grade_name and grade_val:                        grade_name = grade_name.split('-')[0].strip()                        grade_val = grade_val.replace('width:', '').replace('%', '').replace(';', '').strip()                        if grade_name != 'Overall':                            review.grades.append(Grade(name=grade_name, value=float(grade_val)/10, best=10.0))                                pros = content.xpath(".//div[@class='iconProText']")                for pro in pros:                    pro = pro.xpath(".//text()").string(multiple=True)                    if pro:                        review.add_property(type='pros', value=pro)                                cons = content.xpath(".//div[@class='iconConText']")                for con in cons:                    con = con.xpath(".//text()").string(multiple=True)                    if con:                        review.add_property(type='cons', value=con)                        excerpt = rev.xpath("following-sibling::p[1]//text()").string(multiple=True)        if excerpt:            review.properties.append(ReviewProperty(type='excerpt', value=excerpt))                    review.ssid = review.digest()            product.ssid = review.ssid            product.reviews.append(review)                if product.reviews:            session.emit(product)