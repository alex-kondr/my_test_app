from agent import *from models.products import *import simplejsonXCAT = ["Meat & Fish", "Fruit & Veg", "Fresh", "Bakery & Cakes", "Food Cupboard", "Frozen", "Drinks", "Beer, Wines & Spirits", "World Foods", "Free From", "Adult Cat Food (1-6 years)", "Senior Cat Food (7 years+)", "Kitten Food (0-1 years)", "Cat Treats & Milk", "Adult Dog Food (2 years+)", "Senior Dog Food (7 years+)", "Puppy Food (0-2 years)", "Small Breed Dog Food", "Dog Treats, Chews & Biscuits", "Butchers", "Pet Bigger Packs", "Treats", "Advanced Nutrition", "Christmas for Pets", "Advertised Brand", "Baby Milk", "Baby & Toddler Meals & Drinks", "Finger Foods", "HiPP Organic"]def run(context, session):    session.sessionbreakers = [SessionBreak(max_requests=8000)]    session.queue(Request("https://groceries.morrisons.com/browse"), process_category, dict())def process_category(data, context, session):    name = context.get("cat")    cats = data.xpath("//div[contains(@class, 'grocery-section')]//a")    for cat in cats:        name_data = cat.xpath("./text()").string()        if not name_data in XCAT:            cat_name = (name + '|' if name else "") + name_data            url = cat.xpath("@href").string()            session.queue(Request(url), process_category, dict(cat=cat_name, url=url))    if not cats:        json_data = data.xpath("//script[contains(text(), 'window.INITIAL_STATE =')]/text()").string()        json_data = json_data.split("navWithFilters")[-1].split("\"type\":\"BRAND\",")[-1].split('[')[1].split(']')[0]        brands = simplejson.loads("[" + json_data + "]")        for brand in brands:            manufacturer = brand.get("name")            if not manufacturer in XCAT:                url = context["url"] + manufacturer + "-" + brand.get("id")                session.queue(Request(url), process_prodlist, dict(context, manufacturer=manufacturer))def process_prodlist(data, context, session):    prods = context.get("prods", False)    if prods:        resp = simplejson.loads(data.content)        for item in resp:            sku = item.get("sku")            name = item.get("name")            url = "https://groceries.morrisons.com/products/" + sku            revs_url = "https://groceries.morrisons.com/webshop/api/v1/products/" + sku + "/reviews?sortOrder=MOST_RECENT&limit=100&offset=0"            session.queue(Request(revs_url, use="curl"), process_review, dict(context, name=name, sku=sku, url=url))    else:        XSKU = []        prods = data.xpath("//div[contains(@class, 'fop-item')]")        for prod in prods:            name = prod.xpath(".//h4/@title").string()            url = prod.xpath("./div/a/@href").string()            sku = prod.xpath("@data-sku").string()            grade = prod.xpath(".//span[@class = 'fop-rating']")            if not grade:                continue            if url and not sku:                sku = url.split("-")[-1]            if sku:                XSKU.append(sku)                revs_url = "https://groceries.morrisons.com/webshop/api/v1/products/" + sku + "/reviews?sortOrder=MOST_RECENT&limit=100&offset=0"                session.queue(Request(revs_url, use="curl"), process_review, dict(context, name=name, sku=sku, url=url))        script_data = data.xpath("//script[contains(text(), 'window.INITIAL_STATE =')]/text()").string()        if script_data:            script_data = "[" + script_data.split("\"type\": \"OTHER\"")[-1].split("[")[-1].split("]")[0].strip() + "]"            data = simplejson.loads(script_data)            if data:                skus = []                for item in data:                    if type(item.encode("utf-8")) is not str:                        sku = item.get("sku")                        if sku not in XSKU:                            skus.append(sku)                if skus:                    prodlist_url = "https://groceries.morrisons.com/webshop/api/v1/products?skus=" + ",".join(skus)                    session.queue(Request(prodlist_url), process_prodlist, dict(context, prods=True))def process_review(data, context, session):    try:        resp = simplejson.loads(data.content)    except:        resp = simplejson.loads(data.content.split("\r\n")[-1])    revs_total = int(resp.get("totalCount"))    revs = context.get("revs", [])    revs += resp.get("reviews")    if not revs:        return    if revs_total > len(revs):        revs_url = "https://groceries.morrisons.com/webshop/api/v1/products/" + context["sku"] + "/reviews?sortOrder=MOST_RECENT&limit=100&offset=" + str(len(revs))        session.queue(Request(revs_url, use="curl"), process_review, dict(context, revs=revs))    else:        product = Product()        product.name = context["name"]        product.url = context["url"]        product.ssid = context["url"].split("/")[-1]        product.sku = context["sku"]        product.category = context["cat"]        product.manufacturer = context["manufacturer"]        for rev in revs:            review = Review()            review.type = "user"            review.title = rev.get("title")            review.ssid = str(rev.get("reviewId"))            review.date = rev.get("creationDate")            review.url = product.url            author = rev.get("customerNickname")            author_ssid = rev.get("customerNumber")            author_url = "https://groceries.morrisons.com/webshop/readAllCustomerReviews.do?cn=" + author_ssid            review.authors.append(Person(name=author, ssid=author_ssid, profile_url=author_url))            grade = rev.get("rating")            if grade:                review.grades.append(Grade(type="overall", value=float(grade), worst=0.0, best=5.0))            excerpt = rev.get("text")            if excerpt:                review.properties.append(ReviewProperty(type='excerpt', value=excerpt))                product.reviews.append(review)        if product.reviews:            session.emit(product)