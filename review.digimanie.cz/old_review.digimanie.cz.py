from agent import *from models.products import *def run(context, session):    session.sessionbreakers = [SessionBreak(max_requests=3000)]    session.queue(Request('https://www.digimanie.cz/recenze/'), process_revlist, dict())def process_revlist(data, context, session):    for rev in data.xpath("//div[@class='box articles in-recs']//div[@class='article-new']"):        name = rev.xpath(".//h2//text()").string()        url = rev.xpath(".//a//@href").string()        session.queue(Request(url), process_review, dict(url=url, name=name))    next_url = data.xpath("//div[@class='content']//a[contains(text(), 'tarší recenze')]/@href").string()    if next_url:        session.queue(Request(next_url), process_revlist, dict(context))def process_review(data, context, session):    product = Product()    product.name = context['name']    product.ssid = context['url'].split('/')[-1]    product.url = context['url']    cats = data.xpath("//div[@itemprop='itemListElement']//span")    categories = []    for cat in cats:        cat = cat.xpath(".//text()").string(multiple=True)        if cat not in ['Recenze']:            manufacturer = cat            categories.append(cat)    product.category = "|".join(categories)    product.manufacturer = manufacturer    if '(' in context['name']:        mpn = context['name'].split('(')[-1].split(')')[0]        if mpn and len(mpn) > 5:            product.add_property(type='id.manufacturer', value=mpn)    review = Review()    review.title = context['name']    review.ssid = product.ssid    review.type = 'pro'    review.url = context['url']    review.date = data.xpath("//time[@itemprop='datePublished']/@datetime").string()    author = data.xpath("//a[@itemprop='author']").first()    if author:        author_name = author.xpath(".//text()").string()        author_url = author.xpath("@href").string()        review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_name))    grade_overall = data.xpath("//meta[@itemprop='ratingValue']/@content").string()    if grade_overall:        review.grades.append(Grade(type='overall', value=float(grade_overall), best=5.0))    summary = data.xpath("//div[@class='description']//text()").string(multiple=True)    if summary:        review.properties.append(ReviewProperty(type='summary', value=summary))    pages = data.xpath("//div[@class='content']/ol/li//a")    if pages:        review.properties.append(ReviewProperty(type='pages', value=dict(url=review.url, title=review.title)))        last_url = ''        for page in pages:            url = page.xpath("@href").string()            last_url = url            title = page.xpath(".//text()").string()            review.properties.append(ReviewProperty(type='pages', value=dict(url=url, title=title)))        if last_url:            session.do(Request(last_url), process_review_last, dict(context, review=review))    else:        excerpt = data.xpath("//div[@itemprop='reviewBody']//text()").string(multiple=True)        if excerpt:            if summary:                excerpt = excerpt.replace(summary, '')            excerpt = excerpt.split("Plusy")[0].split("Minusy")[0]            review.properties.append(ReviewProperty(type='excerpt', value=excerpt))        if data.xpath("//*[contains(text(),'Plusy')]"):            pros = data.xpath("//h2[contains(@style,'color:')]//following-sibling::div//*[contains(text(),'+')]")            if pros:                pros = set(pros)                for pro in pros:                    pro = pro.xpath("./ancestor::div[1]//text()").string(multiple=True)                    if '+' in pro[0]:                        pro = pro.lstrip('+ ')                        review.add_property(type='pros', value=pro)            else:                pros = data.xpath("//*[contains(text(),'+ ')]//text()").string(multiple=True)                if pros:                    pros = set(pros)                    for pro in pros:                        if '+' in pro[0]:                            pro = pro.lstrip('+ ')                            review.add_property(type='pros', value=pro)            cons = data.xpath("//h2[contains(@style,'color:')]//following-sibling::div//*[contains(text(),'-')]")            if cons:                cons = set(cons)                for con in cons:                    con = con.xpath("./ancestor::div[1]//text()").string(multiple=True)                    if '-' in con[0]:                        pro = pro.lstrip('- ')                        review.add_property(type='cons', value=con)            else:                cons = data.xpath("//*[contains(text(),'- ')]//text()").string(multiple=True)                if cons:                    cons = set(cons)                    for con in cons:                        if '-' in con[0]:                            con = con.lstrip('- ')                            review.add_property(type='cons', value=con)    product.reviews.append(review)    session.emit(product)def process_review_last(data, context, session):    review = context['review']    conclusion = data.xpath("//div[@itemprop='reviewBody']//text()").string(multiple=True)    if conclusion:        conclusion = conclusion.split("Plusy")[0].split("Minusy")[0]        review.properties.append(ReviewProperty(type='conclusion', value=conclusion))    if data.xpath("//*[contains(text(),'Plusy')]"):        pros = data.xpath("//h2[contains(@style,'color:')]//following-sibling::div//*[contains(text(),'+')]")        if pros:            pros = set(pros)            for pro in pros:                pro = pro.xpath("./ancestor::div[1]//text()").string(multiple=True)                if '+' in pro[0]:                    pro = pro.lstrip('+ ')                    review.add_property(type='pros', value=pro)        else:            pros = data.xpath("//*[contains(text(),'+ ')]//text()").string(multiple=True)            if pros:                pros = set(pros)                for pro in pros:                    if '+' in pro[0]:                        pro = pro.lstrip('+ ')                        review.add_property(type='pros', value=pro)        cons = data.xpath("//h2[contains(@style,'color:')]//following-sibling::div//*[contains(text(),'-')]")        if cons:            cons = set(cons)            for con in cons:                con = con.xpath("./ancestor::div[1]//text()").string(multiple=True)                if '-' in con[0]:                    con = con.lstrip('- ')                    review.add_property(type='cons', value=con)        else:            cons = data.xpath("//*[contains(text(),'- ')]//text()").string(multiple=True)            if cons:                cons = set(cons)                for con in cons:                    if '-' in con[0]:                        con = con.lstrip('- ')                        review.add_property(type='cons', value=con)