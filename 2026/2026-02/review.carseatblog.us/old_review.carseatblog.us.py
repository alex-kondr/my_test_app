from agent import *from models.products import *debug = Truedef getexcerpt(txtlist):    excerpt = ''    txtlist = [o.string().strip() for o in txtlist]    for line in txtlist:        excerpt += ' ' + line        if re_search_once("([!?.])$", line) and len(line) > 100:            break    excerpt = re.compile("\s+").sub(' ', excerpt)    return excerpt.strip()def run(context, session):    session.browser.agent = "Mozilla/6.0"    session.queue(Request('http://carseatblog.com/reviews/', use='curl'), process_revlist, {})def process_revlist(data, context, session):    for rev in data.xpath("//p//em//strong"):        title = rev.xpath(".//parent::em//following-sibling::a//text()").string(multiple=True)        name = rev.xpath(".//text()").string(multiple=True)        url = rev.xpath(".//parent::em//following-sibling::a//@href").string()        category = rev.xpath(".//parent::em//parent::p//preceding-sibling::h3[1]//text()").string(multiple=True)        if url and title and name:            if 'REVIEWS :' in category:                category = category.replace('REVIEWS :', '')                fname = name.replace(':', '')            session.queue(Request(url, use='curl'), process_review, dict(context, title=title, name=fname, url=url, category=category))def process_review(data, context, session):    product = Product()    product.name = context['name']    product.url = context['url']    product.ssid = re_search_once('\/(\d+)\/', product.url)    product.category = context['category']    review = Review()    review.type = 'pro'    review.title = context['title']    review.url = product.url    review.ssid = product.ssid    date = data.xpath("//i[@class='fa fa-calendar']//following-sibling::span//text()").string()    if date:         review.date = date    author_name = data.xpath("//a[contains(@title, 'Posts by')]//text()").string()    author_url = data.xpath("//a[contains(@title, 'Posts by')]//@href").string()    if author_url and author_name:        author_ssid = author_url.split('author/')[-1].split('/')[0]        review.authors.append(Person(name=author_name, ssid=author_ssid, profile_url=author_url))    excerpt = ''    txtlist = data.xpath("//p//text()")    if txtlist:        excerpt = getexcerpt(txtlist)        if excerpt:            review.properties.append(ReviewProperty(type=ReviewPropertyType(name='excerpt'), value=excerpt))    pros = data.xpath("descendant::node()[regexp:test(normalize-space(.),'^(Advantages|Pros)','i')]/following-sibling::node()[normalize-space(.)][1]/li")    if not(pros):        pros = data.xpath("descendant::node()[regexp:test(normalize-space(.),'(Advantages|Pros):?')]/following-sibling::node()[normalize-space(.)][1]/li")    if not(pros):        pros = data.xpath("descendant::node()[regexp:test(normalize-space(.),'^(Advantages|Pros)','i')]/following-sibling::node()[normalize-space(.)][2]/li")    for pro in pros:        line = pro.xpath("descendant::text()").string(multiple=True)        if line:            review.properties.append(ReviewProperty(type='pros', value=line))    cons = data.xpath("descendant::node()[regexp:test(normalize-space(.),'^(Disadvantages|Cons)','i')]/following-sibling::node()[normalize-space(.)][1]/li")    if not(cons):        cons = data.xpath("descendant::node()[regexp:test(normalize-space(.),'(Disadvantages|Cons):?')]/following-sibling::node()[normalize-space(.)][1]/li")    if not(cons):        cons = data.xpath("descendant::node()[regexp:test(normalize-space(.),'^(Disadvantages|Cons)','i')]/following-sibling::node()[normalize-space(.)][2]/li")    for con in cons:        line = con.xpath("descendant::text()").string(multiple=True)        if line:            review.properties.append(ReviewProperty(type='cons', value=line))    conclusion = data.xpath("//h5//strong[regexp:test(text(),'(Conclusion|Bottom Line)', 'i')]//parent::h5//following-sibling::p[1]//text()").string(multiple=True)    if not(conclusion):        conclusion = data.xpath("//p//strong[regexp:test(text(),'(Conclusion|Bottom Line)', 'i')]//parent::p//following-sibling::p[1]//text()").string(multiple=True)    if not(conclusion):        conclusion = data.xpath("//h4[regexp:test(text(),'(Conclusion|Bottom Line)', 'i')]//following-sibling::p[1]//text()").string(multiple=True)    if conclusion:        review.properties.append(ReviewProperty(type='conclusion', value=conclusion))    if conclusion or excerpt:        product.reviews.append(review)        session.emit(product)