from agent import *from models.products import *DUPE_PRODS = set()def run(context, session):    session.queue(Request('https://www.projectorscreen.com/blog?categories=259', use='curl', force_charset='utf-8'), process_revlist, dict(cat='Projectors', cat_id='259'))    session.queue(Request('https://www.projectorscreen.com/blog?categories=186', use='curl', force_charset='utf-8'), process_revlist, dict(cat='Movies', cat_id='186'))def process_revlist(data, context, session):    revs = data.xpath('//h2[contains(@class, "BlogPostTitle")]/a')    for rev in revs:        title = rev.xpath('text()').string()        url = rev.xpath('@href').string()        session.queue(Request(url, use='curl', force_charset='utf-8'), process_reviews, dict(context, title=title, url=url))    next_page = data.xpath('//li[contains(@class, "pagination-next")]/a/@href').string()    if next_page:        next_page = next_page.split('CF%80=')[-1]        next_url = 'https://www.projectorscreen.com/blog?categories={}&pi={}'.format(context['cat_id'], next_page)        session.queue(Request(next_url, use='curl', force_charset='utf-8'), process_revlist, dict(context))def process_reviews(data, context, session):    prods = data.xpath('//div[@class="gfi-alt-sticky"]/dl') or data.xpath('//div[@itemprop="itemListElement"]') or data.xpath('//div[contains(@class, "blog-product-sidecontent")]') or data.xpath('//div[@class="countdown-box-content"]')    if not prods:        process_review(data, context, session)        return    for prod in prods:        product = Product()        product.name = prod.xpath('.//div[@class="item-name"]/a/text()').string() or prod.xpath('.//span[@itemprop="name"]/text()').string() or prod.xpath('.//div[@class="usco-header__title"]/h3/text()').string() or prod.xpath('.//div[@class="cbc-title"]/text()').string()        product.url = prod.xpath('.//div[@class="item-name"]/a/@href').string() or prod.xpath('.//div[@class="cbc-title"]/a/@href').string() or prod.xpath('.//div[@class="index-featPS-name"]/a/@href').string() or context['url']        product.manufacturer = prod.xpath('.//tr[contains(., "Brand:")]//td[last()]/div/text()').string()        product.category = context['cat']        product.ssid = prod.xpath('@data-itemid').string() or prod.xpath('.//div//@data-itemid').string() or prod.xpath('.//div//@data-item-id').string()        if not product.ssid:            product.ssid = context['url'].split('/')[-1] + '-' + product.name.lower().replace(' ', '-').replace(':', "-").replace(',', "-").replace('.', '-')        product.sku = prod.xpath('@data-contactsku').string() or prod.xpath('.//div/@data-contactsku').string()        if product.ssid in DUPE_PRODS:            continue        review = Review()        review.title = context['title']        review.type = 'pro'        review.url = context['url']        review.ssid = product.ssid        date = data.xpath('//meta[@property="og:updated_time"]/@content').string() or data.xpath('//div[@class="blog-attrib-date"]/text()').string()        if date:            review.date = date.split('day, ')[-1].split('T')[0]        author = data.xpath('//div[@class="blog-attribution"]').first() or data.xpath('//div[@class="usco-brianblurb-attrib"]/div/img').first()        if author:            author_name = author.xpath('div//span/text()').string() or author.xpath('@alt').string()            author_url = author.xpath('.//div[@class="blog-attrib-pic"]/a/@href').string()            if author_name and author_url:                author_ssid = author_url.split('/')[-1]                review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_ssid))            elif author_name:                review.authors.append(Person(name=author_name, ssid=author_name))        pros = prod.xpath('.//h4[regexp:test(., "Reasons to Buy", "i")]/following-sibling::*[1][self::ul]/li/text()').strings()        for pro in pros:            review.properties.append(ReviewProperty(type='pros', value=pro.strip()))        cons = prod.xpath('.//h4[regexp:test(., "Reasons to Avoid", "i")]/following-sibling::*[1][self::ul]/li/text()').strings()        for con in cons:            review.properties.append(ReviewProperty(type='cons', value=con.strip()))        grades1 = prod.xpath('.//div[@class="usco-subheading"]')        for grade1 in grades1:            name1 = grade1.xpath('.//span/text()').string()            grades2 = grade1.xpath('following-sibling::*[1][self::div[@class="usco-review-wrap"]]//div[@class="usco-review-scores-box"]')            for grade2 in grades2:                name2 = grade2.xpath('strong/text()').string()                grade_name = (name1 + '|' + name2).strip(' |')                value = grade2.xpath('span/text()').string()                if grade_name and value and value.replace('.', '').isdigit() and value > 0:                    review.grades.append(Grade(name=grade_name, value=value, best=10.0))        multi_grade = prod.xpath('.//ul/li[regexp:test(., "IMDB Score", "i")]/text()').string()        if multi_grade:            multi_grade = multi_grade.split('/')[0].split()[-1].strip().replace(',', '.')            review.grades.append(Grade(name='IMDB Score', value=float(multi_grade), best=10.0))        grade_overall = prod.xpath('.//div[not(regexp:test(., "X", "i")) and contains(@class, "usco-review-scores-overall")]/span/text()').string()        if grade_overall:            review.grades.append(Grade(type="overall", value=float(grade_overall), best=10.0))        excerpt = prod.xpath('//div[contains(@class, "blog-product-sidecontent")]//div[contains(@class, "usco-brianblurb well")]/p//text()').string(multiple=True)        if not excerpt:            excerpt = prod.xpath('.//div[@class="cbc-desc"]/p//text()').string(multiple=True)        if not excerpt:            excerpt_1 = prod.xpath('.//div[contains(@class, "usco-brianblurb well")]/p//text()').string(multiple=True) or ''            excerpt_2 = prod.xpath('.//div[contains(@class, "usco-features") and contains(@class, "-inner")]//text()').string(multiple=True) or ''            excerpt = (excerpt_1 + ' ' + excerpt_2).strip()        if not excerpt:            excerpt = prod.xpath('.//div[@class="cbc-desc"]//text()').string(multiple=True)        if excerpt:            review.properties.append(ReviewProperty(type='excerpt', value=excerpt))            product.reviews.append(review)            session.emit(product)def process_review(data, context, session):    product = Product()    product.name = data.xpath('//div[contains(@class, "ControlItem")]/div[contains(@class, "name")]/a/text()').string() or data.xpath('//div[@itemprop="articleBody"]/h3[1][contains(., "(19") or contains(. ,"(20")]/text()').string() or context['title']    product.url = data.xpath('//div[contains(@class, "ControlItem")]/a/@href').string() or context['url']    manufacturer = data.xpath('//div[contains(@class, "ControlItem")]//tr[contains(., "Brand:")]//td[last()]/div/text()').string() or data.xpath('//div[@itemprop="articleBody"]/p/text()[contains(., "Directors:") or contains(., "Director:")]').string()    if manufacturer:        product.manufacturer = manufacturer.split('Directors:')[-1].split('Director:')[-1]    product.category = context['cat']    genre = data.xpath('//div[@itemprop="articleBody"]/p/text()[contains(., "Genre:")]').string()    if genre:        product.category += "|" + genre.split(': ')[-1].replace(' | ', '|')    product.ssid = data.xpath('//div[contains(@class, "ControlItem")]//@data-item-id').string() or context['url'].replace('.html', '').split('-review')[0].split('-Review')[0].split('/')[-1].lower()    product.sku = data.xpath('//div[contains(@class, "ControlItem")]/parent::div/@data-contactsku').string()    DUPE_PRODS.add(product.ssid)    review = Review()    review.title = context['title']    review.type = 'pro'    review.url = context['url']    review.ssid = product.ssid    date = data.xpath('//div[@class="blog-attrib-date"]/text()').string()    if date:        review.date = date.split('day, ')[-1]    author = data.xpath('//div[contains(@class, "author-name")]').first() or data.xpath('//div[@class="blog-attribution"]').first()    if author:        author_name = author.xpath('div//span/text()').string() or author.xpath('text()').string()        author_url = author.xpath('.//div[@class="blog-attrib-pic"]/a/@href').string()        if author_name and author_url:            author_ssid = author_url.split('/')[-1]            review.authors.append(Person(name=author_name, profile_url=author_url, ssid=author_ssid))        elif author_name:            review.authors.append(Person(name=author_name, ssid=author_name))    pros = data.xpath('//div[@class="brb__pros"]/ul/li')    for pro in pros:        pro = pro.xpath('.//text()').string(multiple=True)        review.properties.append(ReviewProperty(type='pros', value=pro))    cons = data.xpath('//div[@class="brb__cons"]/ul/li')    for con in cons:        con = con.xpath('.//text()').string(multiple=True)        review.properties.append(ReviewProperty(type='cons', value=con))    grades = data.xpath('//div[@class="brb__points"]/div')    for grade in grades:        grade_name = grade.xpath('strong/text()').string().strip(': ')        grade_value = grade.xpath('count(.//svg[contains(@class, "fa-star ")])') + grade.xpath('count(.//svg[contains(@class, "fa-star-half")]) div 2')        if grade_name and grade_value and grade_value > 0:            review.grades.append(Grade(name=grade_name, value=grade_value, best=5.0))    grade_overall = data.xpath('//div[contains(@class, "psco-blog-rating-box")]/strong/text()').string()    if grade_overall:        review.grades.append(Grade(type="overall", value=float(grade_overall), best=10.0))    summary = data.xpath('//div[contains(@class, "blog-review-box")]/p[preceding-sibling::*[self::h4 or self::h2][regexp:test(., "Summary", "i") or regexp:test(., "Highlight", "i")]]//text()').string(multiple=True)    if summary:        review.properties.append(ReviewProperty(type='summary', value=summary))    conclusion = ''    conc_text = data.xpath('//div[@itemprop="articleBody"]/h2[regexp:test(., "Summing", "i") or regexp:test(., "conclusion", "i") or regexp:test(., "final thought", "i")]/following-sibling::*')    for line in conc_text:        if line.xpath('self::div or self::h2'):            break        elif line.xpath('self::p//text()'):            conclusion += ' ' + line.xpath('self::p//text()').string(multiple=True)    if not conc_text:        conclusion = data.xpath('//div[@class="psco-blog-rating-desc"]/p//text()').string(multiple=True)    if conclusion and conclusion.strip():        review.properties.append(ReviewProperty(type='conclusion', value=conclusion.strip()))    excerpt = data.xpath('//div[@itemprop="articleBody"]/p[not(preceding-sibling::h2[regexp:test(., "Summing", "i") or regexp:test(., "conclusion", "i") or regexp:test(., "final thought", "i")])][not(regexp:test(., "Cast:", "i") or regexp:test(., "Director:", "i") or regexp:test(., "Country:", "i") or regexp:test(., "Genre:", "i") or regexp:test(., "Editor.s Notes:", "i"))]//text() | //div[@itemprop="articleBody"]/blockquote//text()').string(multiple=True)    if excerpt:        review.properties.append(ReviewProperty(type='excerpt', value=excerpt))        product.reviews.append(review)        session.emit(product)