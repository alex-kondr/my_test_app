from agent import *from models.products import *debug = Trueimport redef run(context, session):   session.browser.agent = "Mozilla/6.0"   session.sessionbreakers = [SessionBreak(max_requests=15000)]   session.do(Request('https://portal.zwame.pt/57564/analise/toshiba-ocz-rc500', use='curl'), process_review, dict(url="https://portal.zwame.pt/57564/analise/toshiba-ocz-rc500"))   session.queue(Request('http://portal.zwame.pt/category/analise', use='curl'), process_revlist, dict())def process_revlist(data, context, session):   for rev in data.xpath("//h2[@class='post-title']/a"):      url = rev.xpath("@href").string()      session.queue(Request(url, use='curl'), process_review, dict(context, url=url))   nexturl = data.xpath("//li[@class='the-next-page']/a/@href").string()   if nexturl:      session.queue(Request(nexturl, use='curl'), process_revlist, context) def process_review(data, context, session):   product = Product()   product.url = context['url']   product.ssid = product.url.split("/")[3]   product.name = data.xpath("//h1[@class='post-title entry-title']//text()").string(multiple=True)      product.category = data.xpath("//div[@class='entry-header']/span[@class='post-cat-wrap']//text()").string(multiple=True)   review = Review()   review.type = 'pro'   review.title = product.name   review.url = product.url   review.ssid = product.ssid   author = data.xpath("//a[@class='author-name']").first()   if author:      name = author.xpath(".//text()").string(multiple=True)      url = author.xpath("@href").string()      if url and name:         review.authors.append(Person(name=name, ssid=name, profile_url=url))   lasturl = ''   pages  = data.xpath("//a[@class='post-page-numbers']")   if pages:      review.properties.append(ReviewProperty(type='pages', value=dict(url=review.url, title='Page 1')))      for page in pages:         title = page.xpath(".//text()").string(multiple=True)         if "Página" in title:            continue         url = page.xpath("@href").string()         if url and title:            lasturl = url            review.properties.append(ReviewProperty(type='pages', value=dict(url=url, title='Page %s'%(title))))   if lasturl:      session.do(Request(lasturl, use='curl'), process_lastpage, dict(context, product=product, review=review))def process_lastpage(data, context, session):   product = context['product']   review = context['review']   pros = data.xpath("//div[@class='the_content']/node()[regexp:test(normalize-space(.),'(Aspectos Positivos|Destaco pela Positiva)')]/following-sibling::ul[1]/li")   if not(pros):      pros = data.xpath("//div[@class='the_content']/p[regexp:test(normalize-space(.),'^-')][preceding-sibling::p[strong][1][regexp:test(normalize-space(.),'Aspectos Positivos')]]")   if not(pros):      pros = data.xpath("//div[@class='the_content']/p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]/text()[preceding::span[1][regexp:test(@style,'(008000|339966)')]]")   for pro in pros:      line = pro.xpath("descendant-or-self::text()").string(multiple=True)      if line:         review.properties.append(ReviewProperty(type='pros', value=line))     cons = data.xpath("//div[@class='the_content']/node()[regexp:test(normalize-space(.),'(Aspectos Negativos|Aspectos a melhorar|Destaco pela Negativa)')]/following-sibling::ul[1]/li")   if not(cons):      cons = data.xpath("//div[@class='the_content']/p[regexp:test(normalize-space(.),'^-')][preceding-sibling::p[strong][1][regexp:test(normalize-space(.),'Aspectos Negativos')]]")   if not(cons):      cons = data.xpath("//div[@class='the_content']/p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]/text()[preceding::span[1][regexp:test(@style,'(ff0000|993300|ff9900)')]]")   for con in cons:      line = con.xpath("descendant-or-self::text()").string(multiple=True)      if line:         review.properties.append(ReviewProperty(type='cons', value=line))   conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]//text()[following::text()[regexp:test(normalize-space(.),'Aspectos Positivos')]]").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')]]//text()[following::text()[regexp:test(normalize-space(.),'Aspectos Positivos')]]").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]//text()[following::span[regexp:test(@style,'(008000|339966)')]]").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')]]//text()[following::span[regexp:test(@style,'(008000|339966)')]]").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[not(regexp:test(normalize-space(.),'^-'))][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]//text()").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[not(regexp:test(normalize-space(.),'^-'))][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')]]//text()").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')] and following-sibling::node()[regexp:test(normalize-space(.),'Agradecimento')]]//text()").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//div[@class='the_content']//p[normalize-space(text())][preceding-sibling::node()[regexp:test(normalize-space(.),'Conclusão')]]//text()").string(multiple=True)   if not conclusion:      conclusion = data.xpath("//strong[contains(., 'Nota final')]/parent::p//text()").string(multiple=True)   if not conclusion:      conclusion = data.xpath("(//h3[contains(., 'Testes e Conclusăo')]/following-sibling::p)[1]//text()").string(multiple=True)      if not conclusion:      for i in ['h3', 'h2', 'h1', 'h6', 'h5', 'h4', 'p']:         for k in ['Conclusão', 'conclusão', 'CONCLUSÃO', 'Conclusões', 'conclusões', 'Nota finais', 'Notas finais', 'Opinião Final', 'Considerações Finais']:            conclusion = data.xpath("//"+i+"[contains(., '"+k+"')]/following-sibling::p//text()").string(multiple=True)            if conclusion:               conclusion = conclusion.split("Agradecimento")[0].split("Copyright")[0].split("Autor")[0].split("INDICE")[0].split("A ZWAME agradece")[0].split("A Favor")[0].replace("Nota final", "")               if conclusion == "":                  conclusion = None               break         else:            continue         break   if not conclusion:      conclusion = data.xpath("//div[@class='entry-content entry clearfix']/p[last()]//text()").string(multiple=True)   if conclusion:      conclusion = conclusion.split("Agradecimento")[0].split("Copyright")[0].split("Autor")[0].split("INDICE")[0].split("A ZWAME agradece")[0].split("A Favor")[0].replace("Nota final", "")      review.properties.append(ReviewProperty(type='conclusion', value=conclusion))   if conclusion:      product.reviews.append(review)      session.emit(product)