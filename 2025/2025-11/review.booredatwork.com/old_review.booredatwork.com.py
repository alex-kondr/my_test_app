from agent import *from models.products import *def process_revlist(data, context, session):    revs = data.xpath("//div[@class='post-c-wrap']/h4[@class='title']/a")    for rev in revs:        name = rev.xpath("text()").string()        url = rev.xpath("@href").string()        if name:            session.queue(Request(url, use="curl"), process_review, dict(url=url, name=name))    if revs:        next_page = context['page'] + 1        next_url = 'https://booredatwork.com/category/review/page/' + str(next_page)        session.queue(Request(next_url, use="curl"), process_revlist, dict(context, page=next_page))    def process_review(data, context, session):    product = Product()    product.name = context['name']    product.url = context['url']    product.ssid = context['url'].split("/")[-2]    category = data.xpath("//div[@class='breadcrumbs']/a//text()").string()    if not category:        for cat in data.xpath("//div[@class='s-tags']/a"):            if 'eview' not in cat.string():                category = cat.string()                break    product.category = category or 'Review'    review = Review()    review.type = 'pro'    review.title = product.name    review.url = product.url    review.ssid = product.ssid    review.date = data.xpath("//div[@class='meta']/div[@class='post-date']//text()").string()        aut = data.xpath("//div[@class='meta']/div[@class='post-author']/a//text()").string()    aurl = data.xpath("//div[@class='meta']/div[@class='post-author']/a//@href").string()    if aut and aurl:        review.authors.append(Person(name=aut, profile_url=aurl, ssid=aut))    conclusion = data.xpath("//*[contains(text(),'Final Thoughts')]//following-sibling::p//text() | //*[contains(text(),'Conclusion')]//following-sibling::p//text() | //*[contains(text(),'Conclusion:')]//following-sibling::p//text() | //*[contains(text(),'Conclusions:')]//following-sibling::p//text() | //*[contains(text(),'Conclusion;')]//following-sibling::p//text()").string(multiple=True)    excerpt = data.xpath("//div[@class='article-content clearfix']//text()").string(multiple=True)    excerpt = excerpt.split("Conclusion")[0].split("Final Thoughts")[0].split("Conclusion:")[0].split("Conclusions:")[0].split("Conclusion;")[0].split("â€ ")[0]    if conclusion:        if excerpt:            excerpt = excerpt.replace(conclusion, "")        review.properties.append(ReviewProperty(type='conclusion', value=conclusion))    if excerpt:        review.properties.append(ReviewProperty(type='excerpt', value=excerpt))    product.reviews.append(review)    session.emit(product)def run(context, session):    session.queue(Request("http://booredatwork.com/category/review/", use='curl'), process_revlist, dict(page=1))